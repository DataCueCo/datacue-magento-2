<?php
/**
 * @var \Datacue\MagentoModule\AdminPage\Setting $block
 */
$apiKey = $block->getApiKey();
$apiSecret = $block->getApiSecret();
$customCss = $block->getCustomCss();
$recommendationSettings = $block->getRecommendationSettings();
?>
<div id="datacue-tabs">
  <ul>
    <li><a href="#tab-settings">Settings</a></li>
    <li><a href="#recommendations">Recommendations</a></li>
    <li><a href="#tab-custom-css">Custom CSS</a></li>
    <li><a href="#tab-sync-status">Sync Status</a></li>
    <li><a href="#tab-logs">Logs</a></li>
  </ul>
  <div id="tab-settings">
    <form style="font-size: 20px;" method="post" action="<?php echo $this->getUrl('datacue_magento/setting/save'); ?>">
      <div style="margin: 10px 0;">
        <label for="api_key" style="display: inline-block; width: 100px; text-align: right;">API key</label>
        <input id="api_key" name="api_key" style="width: 300px;" value="<?php echo $apiKey ?>" <?php if (!empty($apiKey)) { echo 'disabled="disabled"'; } ?> />
      </div>
      <div style="margin: 10px 0;">
        <label for="api_secret" style="display: inline-block; width: 100px; text-align: right;">API secret</label>
        <input id="api_secret" name="api_secret" type="password" style="width: 300px;" value="<?php echo empty($apiSecret) ? '' : '****************' ?>" <?php if (!empty($apiSecret)) { echo 'disabled="disabled"'; } ?> />
      </div>
      <?php
        if (!empty($apiKey) || !empty($apiSecret)) {
      ?>
      <a id="btn-disconnect" class="btn-disconnect" href="javascript:;">DISCONNECT FROM DATACUE</a>
      <?php
        } else {
      ?>
      <input name="form_key" type="hidden" value="<?php /** @escapeNotVerified */ echo $this->getFormKey() ?>" />
      <button class="ui-button ui-widget ui-corner-all" style="font-size: .8em; margin-left: 105px;">Save</button>
      <?php
        }
      ?>
    </form>
    <div class="datacue-helper-section">
      <h2>Here are some resources you might find helpful</h2>
      <ul class="list">
        <li><a href="https://help.datacue.co/install/magento.html#add-recommendations" target="_blank">Add banners and products to your site</a></li>
      </ul>
    </div>
    <div class="datacue-helper-section">
      <a class="a-login" href="https://app.datacue.co" target="_blank">LOGIN TO MY DATACUE DASHBOARD</a>
      <div class="a-sign-up">No account yet? Sign up <a href="https://app.datacue.co/en/sign-up" target="_blank" style="color: #8c5c85; font-weight: 600;">here</a></div>
    </div>
    <div class="datacue-helper-section">
      <h2>Support Center</h2>
      <p>Questions? Need help? Email us at <a href="mailto:support@datacue.co" target="_blank">support@datacue.co</a> to speak to a real person</p>
    </div>
    <div id="dialog-disconnect" class="hide">
      <div class="card">
        <div class="title">Are you sure?</div>
        <div class="description">
          Disconnecting will delete all data from DataCue and disable recommendations!
        </div>
        <div class="footer">
          <button id="disconnect-ok">Disconnect</button>
          <button id="disconnect-cancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <div id="recommendations">
    <form style="font-size: 14px;" method="post" action="<?php echo $this->getUrl('datacue_magento/recommendation/save'); ?>">
      <div style="margin: 10px 0;">
        <label for="products_status_for_product_page" style="display: inline-block; width: 200px; text-align: right;">Add products to product page</label>
        <select name="products_status_for_product_page">
          <option value="0">Disabled</option>
          <option value="1">Enabled</option>
        </select>
      </div>
      <div style="margin: 10px 0;">
        <label for="products_type_for_product_page" style="display: inline-block; width: 200px; text-align: right;">Recommendation type</label>
        <select name="products_type_for_product_page">
          <option value="all">All</option>
          <option value="recent">Recently Viewed</option>
          <option value="similar">Similar to current product</option>
          <option value="related">Related Products</option>
        </select>
      </div>
      <input name="form_key" type="hidden" value="<?php /** @escapeNotVerified */ echo $this->getFormKey() ?>" />
      <button class="ui-button ui-widget ui-corner-all" style="font-size: .8em; margin-left: 205px;">Save</button>
    </form>
  </div>
  <div id="tab-custom-css">
    <form style="font-size: 14px;" method="post" action="<?php echo $this->getUrl('datacue_magento/customcss/save'); ?>">
      <textarea name="css" rows="20" style="width: 100%;"><?php echo $customCss; ?></textarea>
      <input name="form_key" type="hidden" value="<?php /** @escapeNotVerified */ echo $this->getFormKey() ?>" />
      <button class="ui-button ui-widget ui-corner-all" type="submit" style="font-size: .8em;">Save</button>
    </form>
  </div>
  <div id="tab-sync-status">
    <table id="datacue-sync-status-table">
      <thead>
      <tr>
        <th width="100">Data Type</th>
        <th width="100">Total</th>
        <th width="100">Number of pending</th>
        <th width="100">Number of successes</th>
        <th width="100">Number of failures</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="tab-logs">
    <?php
      // Dates
      $dates = '<select id="datacue-logs-date-select">';
      $timestamp = time();
      for ($i = 0; $i < 3; $i++) {
          $date = date('Y-m-d', $timestamp);
          if (file_exists(__DIR__ . "/../../../datacue-$date.log")) {
              $dates .= "<option value=\"$date\"" . ($i === 0 ? ' selected' : '') . ">$date</option>";
          }
          $timestamp -= 24 * 3600;
      }
      $dates .= '</select>';
      echo $dates;
    ?>
    <iframe id="datacue-log-frame" src="" style="width: 100%; height: 500px; border: 0.5px solid #eee; margin-top: 5px;"></iframe>
  </div>
</div>
<script>
  function getSyncStatus($) {
    $.ajax({
      showLoader: false,
      url: '<?php echo $this->getUrl('datacue_magento/sync/status'); ?>',
      type: "POST",
      data: {
        form_key: FORM_KEY
      },
      dataType: 'json'
    }).done(function (data) {
      var html = '';
      Object.keys(data).forEach(function (key) {
        html += '<tr>';
        html += '<td align="center">' + key + '</td>';
        html += '<td align="center">' + data[key].total + '</td>';
        html += '<td align="center">' + (data[key].total - data[key].completed - data[key].failed) + '</td>';
        html += '<td align="center">' + data[key].completed + '</td>';
        html += '<td align="center">' + data[key].failed + '</td>';
        html += '</tr>';
      });
      $("#datacue-sync-status-table tbody").html(html);
    });
  };
  function getLogOfDate($, date) {
    $("#datacue-log-frame").attr('src', '<?php echo $this->getUrl('datacue_magento/log/view'); ?>?date=' + date);
  }
  require([
    'jquery',
    'jquery/ui'
  ], function($) {
    $("#datacue-tabs").tabs();
    getSyncStatus($);
    setInterval(function () {
      getSyncStatus($);
    }, 30000);

    var currentDate = jQuery("#datacue-logs-date-select").val();
    if (currentDate && currentDate != '') {
      getLogOfDate($, currentDate);
    }
    $("#datacue-logs-date-select").change(function() {
      getLogOfDate($, $("#datacue-logs-date-select").val());
    });

    $("#btn-disconnect").on("click", function() {
      $("#dialog-disconnect").removeClass("hide");
    });

    $("#disconnect-ok").on("click", function() {
      $.ajax({
        showLoader: true,
        url: '<?php echo $this->getUrl('datacue_magento/setting/disconnect'); ?>',
        type: "POST",
        data: {
          form_key: FORM_KEY
        },
        dataType: 'json'
      }).done(function () {
        $("#dialog-disconnect").addClass("hide");
        window.location.reload();
      });
    });

    $("#disconnect-cancel").on("click", function() {
      $("#dialog-disconnect").addClass("hide");
    });

    $("[name='products_status_for_product_page']").val('<?php echo $recommendationSettings['products_status_for_product_page']; ?>');
    $("[name='products_type_for_product_page']").val('<?php echo $recommendationSettings['products_type_for_product_page']; ?>');
  });
</script>